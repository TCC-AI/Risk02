<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>昶青實業-AI控制管理中心</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: '微軟正黑體', Arial, sans-serif;
    }
    body {
      background-color: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      width: 100%;
      max-width: 500px;
      padding: 20px;
      margin: 0 auto;
    }
    .login-form, .dashboard {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #333;
      font-size: 24px;
    }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    button:not(.btn) {
      width: 100%;
      padding: 12px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover:not(.btn) { background-color: #3367d6; }
    .error-message {
      color: #d93025;
      margin-top: 15px;
      text-align: center;
    }
    .hidden { display: none; }
    .loading { text-align: center; margin-top: 15px; }
    /* ===== Dashboard & Inventory ===== */
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 30px;
    }
    .feature-btn { padding: 20px; font-size: 18px; font-weight: bold; }
    #inventory-btn { background-color: #34a853; }
    #inventory-btn:hover { background-color: #2d9249; }
    #event-btn { background-color: #ea4335; }
    #event-btn:hover { background-color: #d33426; }

    .user-info { text-align: right; margin-bottom: 15px; font-size: 14px; color: #555; }
    .user-info strong { color: #4285f4; }

    .dropdown { margin-top: 20px; }

    .inventory-section {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 100%; max-width: 900px;
      margin: 20px auto;
    }
    .inventory-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
    }
    .back-btn {
      padding: 8px 15px;
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .back-btn:hover { background-color: #5a6268; }
    .inventory-table {
      width: 100%; border-collapse: collapse; margin-bottom: 20px;
    }
    .inventory-table th, .inventory-table td {
      border: 1px solid #ddd; padding: 12px; text-align: left;
    }
    .inventory-table th { background-color: #f8f9fa; font-weight: bold; }
    .inventory-table tr:nth-child(even) { background-color: #f2f2f2; }
    .inventory-actions {
      display: flex; justify-content: center; gap: 15px; margin-top: 20px;
    }
    .submit-btn { background-color: #34a853; width: 150px; }
    .submit-btn:hover { background-color: #2d9249; }
    .reset-btn { background-color: #ea4335; width: 150px; }
    .reset-btn:hover { background-color: #d33426; }
    .select-container select, .input-container input {
      width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;
      font-size: 14px;
    }
    .input-container input:disabled { background-color: #e9ecef; }

    .risk-info { margin-bottom: 10px; }
    .risk-name { font-weight: bold; color: #333; }
    .risk-description { color: #666; font-size: 14px; }
    .risk-category, .risk-level, .related-departments {
      font-size: 13px; color: #777;
    }

    @media (max-width: 768px) {
      .inventory-section { padding: 15px; }
      .inventory-table th, .inventory-table td { padding: 8px; font-size: 14px; }
      .inventory-actions { flex-direction: column; align-items: center; }
      .submit-btn, .reset-btn { width: 100%; margin-bottom: 10px; }
    }
    @media (max-width: 480px) {
      .container { padding: 10px; }
      h1 { font-size: 20px; }
      .feature-btn { padding: 15px; font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="container" id="main-container">
    <!-- 登入表單 -->
    <div id="login-section" class="login-form">
      <h1>昶青實業-AI控制管理中心</h1>
      <div class="form-group">
        <label for="username">帳號</label>
        <input type="text" id="username" placeholder="請輸入帳號"/>
      </div>
      <div class="form-group">
        <label for="password">密碼</label>
        <input type="password" id="password" placeholder="請輸入密碼"/>
      </div>
      <button id="login-btn">登入</button>
      <p id="loading" class="loading hidden">驗證中...</p>
      <p id="error-message" class="error-message"></p>
    </div>

    <!-- 主頁面 -->
    <div id="dashboard-section" class="dashboard hidden">
      <div class="user-info">
        歡迎：<strong id="user-department"></strong> - <strong id="user-name"></strong>
      </div>
      <h1>昶青實業-AI控制管理中心</h1>
      <div class="button-group">
        <button id="inventory-btn" class="feature-btn">部門週期盤點</button>
        <button id="event-btn" class="feature-btn">事件登錄</button>
      </div>
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle w-100 py-2"
                type="button" id="logoutDropdown" data-bs-toggle="dropdown">
          登出選項
        </button>
        <ul class="dropdown-menu w-100" aria-labelledby="logoutDropdown">
          <li><a class="dropdown-item" href="#" id="changePasswordBtn">更改密碼</a></li>
          <li><a class="dropdown-item" href="#" id="logoutBtn">登出</a></li>
        </ul>
      </div>
    </div>

    <!-- 更改密碼 Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
      <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">更改密碼</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="changePasswordForm">
            <div class="mb-3">
              <label class="form-label">目前密碼</label>
              <input type="password" id="currentPassword" class="form-control" required/>
            </div>
            <div class="mb-3">
              <label class="form-label">新密碼</label>
              <input type="password" id="newPassword" class="form-control" required/>
            </div>
            <div class="mb-3">
              <label class="form-label">確認新密碼</label>
              <input type="password" id="confirmPassword" class="form-control" required/>
            </div>
            <div id="passwordChangeMessage" class="alert" style="display:none"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" id="submitChangePassword">確認更改</button>
        </div>
      </div></div>
    </div>
  </div>

  <!-- 盤點區塊 -->
  <div id="inventory-section" class="inventory-section hidden">
    <div class="inventory-header">
      <h1>部門週期盤點</h1>
      <button id="back-btn" class="back-btn">返回前頁</button>
    </div>
    <div id="inventory-loading" class="loading">載入中，請稍候...</div>
    <div id="inventory-content" class="hidden">
      <table class="inventory-table">
        <thead>
          <tr>
            <th style="width:40%">風險項目</th>
            <th style="width:20%">本月是否增加</th>
            <th style="width:15%">發生次數</th>
            <th style="width:25%">原因</th>
          </tr>
        </thead>
        <tbody id="inventory-table-body"></tbody>
      </table>
      <div class="inventory-actions">
        <button id="submit-inventory-btn" class="submit-btn">送出</button>
        <button id="reset-inventory-btn" class="reset-btn">重置</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', ()=> {
      // DOM 元素
      const loginSection = document.getElementById('login-section');
      const dashboardSection = document.getElementById('dashboard-section');
      const inventorySection = document.getElementById('inventory-section');
      const loginBtn = document.getElementById('login-btn');
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const errorMessage = document.getElementById('error-message');
      const loadingMsg = document.getElementById('loading');
      const inventoryBtn = document.getElementById('inventory-btn');
      const eventBtn = document.getElementById('event-btn');
      const logoutBtn = document.getElementById('logoutBtn');
      const changePasswordBtn = document.getElementById('changePasswordBtn');
      const submitChangePasswordBtn = document.getElementById('submitChangePassword');
      const userDepartment = document.getElementById('user-department');
      const userName = document.getElementById('user-name');
      const backBtn = document.getElementById('back-btn');
      const submitInventoryBtn = document.getElementById('submit-inventory-btn');
      const resetInventoryBtn = document.getElementById('reset-inventory-btn');
      const inventoryLoading = document.getElementById('inventory-loading');
      const inventoryContent = document.getElementById('inventory-content');
      const inventoryTableBody = document.getElementById('inventory-table-body');

      // 設定
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxjadwQSmUNf0LxClngUjdL_ssbiufCENKyi9f2bYn5069ALZJEU26w3y3EOQEiDbkR/exec';
      const inactivityTimeout = 15 * 60 * 1000; // 15 分鐘
      let inactivityTimer;

      // 自動登出
      function resetInactivityTimer(){
        clearTimeout(inactivityTimer);
        if(localStorage.getItem('isLoggedIn')==='true'){
          inactivityTimer = setTimeout(()=> {
            alert('因長時間未操作，系統已自動登出');
            doLogout();
          }, inactivityTimeout);
        }
      }
      ['mousedown','mousemove','keypress','scroll','touchstart']
        .forEach(ev=> document.addEventListener(ev, resetInactivityTimer, true));

      // 顯示畫面
      function showLogin(){
        loginSection.classList.remove('hidden');
        dashboardSection.classList.add('hidden');
        inventorySection.classList.add('hidden');
        clearTimeout(inactivityTimer);
      }
      function showDashboard(){
        loginSection.classList.add('hidden');
        dashboardSection.classList.remove('hidden');
        inventorySection.classList.add('hidden');
        resetInactivityTimer();
      }
      function showInventory(){
        loginSection.classList.add('hidden');
        dashboardSection.classList.add('hidden');
        inventorySection.classList.remove('hidden');
        resetInactivityTimer();
      }

      // 登出
      function doLogout(){
        localStorage.clear();
        showLogin();
      }

      // 初始：若已登入
      if(localStorage.getItem('isLoggedIn')==='true'){
        userDepartment.textContent = localStorage.getItem('department');
        userName.textContent = localStorage.getItem('name');
        showDashboard();
      }

      // 登入
      loginBtn.addEventListener('click', ()=>{
        const u = usernameInput.value.trim();
        const p = passwordInput.value.trim();
        if(!u||!p){
          errorMessage.textContent='請輸入帳號和密碼';
          return;
        }
        errorMessage.textContent='';
        loadingMsg.classList.remove('hidden');
        loginBtn.disabled=true;

        fetch(SCRIPT_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'login', username:u, password:p })
        })
        .then(r=>r.json())
        .then(data=>{
          loadingMsg.classList.add('hidden');
          loginBtn.disabled=false;
          if(data.success){
            localStorage.setItem('isLoggedIn','true');
            localStorage.setItem('username',u);
            localStorage.setItem('department',data.department);
            localStorage.setItem('name',data.name);
            userDepartment.textContent=data.department;
            userName.textContent=data.name;
            showDashboard();
          } else {
            errorMessage.textContent = data.message;
          }
        })
        .catch(err=>{
          loadingMsg.classList.add('hidden');
          loginBtn.disabled=false;
          errorMessage.textContent='系統錯誤，請稍後再試';
          console.error(err);
        });
      });

      // 進入盤點
      inventoryBtn.addEventListener('click', ()=>{
        showInventory();
        loadInventoryData();
      });
      backBtn.addEventListener('click', showDashboard);

      // 讀取風險清單
      function loadInventoryData(){
        inventoryLoading.classList.remove('hidden');
        inventoryContent.classList.add('hidden');
        inventoryTableBody.innerHTML = '';
        fetch(`${SCRIPT_URL}`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            action:'getRiskItems',
            department: localStorage.getItem('department')
          })
        })
        .then(r=>r.json())
        .then(data=>{
          inventoryLoading.classList.add('hidden');
          if(data.success){
            renderRiskItems(data.items);
            inventoryContent.classList.remove('hidden');
          } else {
            alert(data.message);
            showDashboard();
          }
        })
        .catch(err=>{
          inventoryLoading.classList.add('hidden');
          alert('系統錯誤，請稍後再試');
          console.error(err);
        });
      }

      // 渲染表格
      function renderRiskItems(items){
        if(items.length===0){
          inventoryTableBody.innerHTML = '<tr><td colspan="4" class="text-center">沒有風險項目</td></tr>';
          return;
        }
        items.forEach((it,i)=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>
              <div class="risk-info">
                <div class="risk-name">${it.name}</div>
                <div class="risk-description">${it.description}</div>
                <div class="risk-category">類別: ${it.category}</div>
                <div class="risk-level">風險等級: ${it.level}</div>
                <div class="related-departments">相關聯部門: ${it.relatedDepartments}</div>
              </div>
            </td>
            <td><select class="increase-select" data-i="${i}">
                  <option value="">請選擇</option>
                  <option value="yes">是</option>
                  <option value="no">否</option>
                </select></td>
            <td><input type="number" class="occurrence-input" data-i="${i}" disabled/></td>
            <td><input type="text" class="reason-input" data-i="${i}" disabled/></td>
          `;
          inventoryTableBody.appendChild(tr);
        });
        document.querySelectorAll('.increase-select').forEach(sel=>{
          sel.addEventListener('change',e=>{
            const i=e.target.dataset.i;
            const occ=document.querySelector(`.occurrence-input[data-i="${i}"]`);
            const reason=document.querySelector(`.reason-input[data-i="${i}"]`);
            if(e.target.value==='yes'){
              occ.disabled=false; reason.disabled=false;
            } else {
              occ.disabled=true; occ.value='';
              reason.disabled=true; reason.value='';
            }
            resetInactivityTimer();
          });
        });
      }

      // 送出盤點
      submitInventoryBtn.addEventListener('click', ()=>{
        const selects = document.querySelectorAll('.increase-select');
        const responses = [];
        let valid=true;
        selects.forEach(sel=>{
          const i=sel.dataset.i;
          const occ=document.querySelector(`.occurrence-input[data-i="${i}"]`);
          const reason=document.querySelector(`.reason-input[data-i="${i}"]`);
          if(!sel.value){
            valid=false; sel.style.borderColor='red';
          } else {
            sel.style.borderColor='';
            if(sel.value==='yes'){
              if(!occ.value){ valid=false; occ.style.borderColor='red'; }
              else occ.style.borderColor='';
              if(!reason.value){ valid=false; reason.style.borderColor='red'; }
              else reason.style.borderColor='';
            }
            const tr = sel.closest('tr');
            responses.push({
              riskName: tr.querySelector('.risk-name').textContent,
              riskDescription: tr.querySelector('.risk-description').textContent,
              riskCategory: tr.querySelector('.risk-category').textContent.replace('類別: ',''),
              riskLevel: tr.querySelector('.risk-level').textContent.replace('風險等級: ',''),
              relatedDepartments: tr.querySelector('.related-departments').textContent.replace('相關聯部門: ',''),
              increased: sel.value==='yes',
              occurrences: sel.value==='yes'?occ.value:0,
              reason: sel.value==='yes'?reason.value:''
            });
          }
        });
        if(!valid){ return alert('請填寫所有必填欄位'); }

        submitInventoryBtn.disabled=true;
        submitInventoryBtn.textContent='送出中...';

        fetch(SCRIPT_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            action:'submitInventory',
            timestamp: new Date().toISOString(),
            department: localStorage.getItem('department'),
            username: localStorage.getItem('username'),
            name: localStorage.getItem('name'),
            responses: responses
          })
        })
        .then(r=>r.json())
        .then(data=>{
          submitInventoryBtn.disabled=false;
          submitInventoryBtn.textContent='送出';
          if(data.success){
            alert('部門週期盤點已成功送出');
            showDashboard();
          } else {
            alert('送出失敗：'+data.message);
          }
        })
        .catch(err=>{
          submitInventoryBtn.disabled=false;
          submitInventoryBtn.textContent='送出';
          alert('系統錯誤，請稍後再試');
          console.error(err);
        });
      });

      resetInventoryBtn.addEventListener('click',()=>{
        document.querySelectorAll('.increase-select').forEach(sel=>{
          sel.value=''; sel.style.borderColor='';
          const i=sel.dataset.i;
          const occ=document.querySelector(`.occurrence-input[data-i="${i}"]`);
          const reason=document.querySelector(`.reason-input[data-i="${i}"]`);
          occ.disabled=true; occ.value=''; occ.style.borderColor='';
          reason.disabled=true; reason.value=''; reason.style.borderColor='';
        });
        resetInactivityTimer();
      });

      // 事件登錄
      eventBtn.addEventListener('click', ()=> {
        alert('導向事件登錄功能...');
        resetInactivityTimer();
      });

      // 登出 / 更改密碼
      logoutBtn.addEventListener('click', doLogout);
      changePasswordBtn.addEventListener('click',()=>{
        document.getElementById('changePasswordForm').reset();
        document.getElementById('passwordChangeMessage').style.display='none';
        new bootstrap.Modal(document.getElementById('changePasswordModal')).show();
        resetInactivityTimer();
      });
      submitChangePasswordBtn.addEventListener('click',()=>{
        const cur = document.getElementById('currentPassword').value;
        const nw  = document.getElementById('newPassword').value;
        const cf  = document.getElementById('confirmPassword').value;
        const msg = document.getElementById('passwordChangeMessage');
        if(nw!==cf){
          msg.className='alert alert-danger';
          msg.textContent='新密碼與確認新密碼不一致！';
          msg.style.display='block';
          return;
        }
        fetch(SCRIPT_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            action:'changePassword',
            username: localStorage.getItem('username'),
            currentPassword: cur,
            newPassword: nw
          })
        })
        .then(r=>r.json())
        .then(d=>{
          if(d.success){
            msg.className='alert alert-success';
            msg.textContent='密碼更改成功！';
            msg.style.display='block';
            setTimeout(()=>bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide(),3000);
          } else {
            msg.className='alert alert-danger';
            msg.textContent=d.message;
            msg.style.display='block';
          }
        })
        .catch(err=>{
          msg.className='alert alert-danger';
          msg.textContent='系統錯誤，請稍後再試';
          msg.style.display='block';
          console.error(err);
        });
      });
    });
  </script>
</body>
</html>
